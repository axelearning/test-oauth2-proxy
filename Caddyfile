external.axelrasse.com:80 {
	reverse_proxy external-service:80
}


axelrasse.com:80 {
	# OAuth2 routes outside protected routes to avoid infinite loop
	handle /oauth2/* {
		reverse_proxy oauth2-proxy:4180 {
			header_up X-Real-IP {remote_host}
			header_up X-Forwarded-Uri {uri}
		}
	}

	handle /admin* {
		forward_auth oauth2-proxy:4180 {
			uri /oauth2/auth
			header_up X-Real-IP {remote_host}

			@error status 401
			handle_response @error {
				redir * /oauth2/sign_in?rd={scheme}://{host}{uri}
			}
		}
		
		handle /admin/portainer* {
			uri strip_prefix /admin/portainer
			reverse_proxy portainer:9000 {
				header_up X-Forwarded-Proto https
				header_up X-Forwarded-Host {host}
				header_up X-Real-IP {remote_host}
			}
		}
		
		handle /admin/internal1* {
			uri strip_prefix /admin/internal1
			reverse_proxy internal1:80
		}
		
		handle /admin/internal2* {
			uri strip_prefix /admin/internal2
			reverse_proxy internal2:80
		}
		
		handle /admin* {
			uri strip_prefix /admin
			reverse_proxy admin-service:80
		}
	}

	handle {
		respond "Main site - Docker setup working!"
	}
}

www.axelrasse.com:80 {
	redir https://axelrasse.com{uri}
}